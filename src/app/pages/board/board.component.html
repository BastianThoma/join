<!--
  BoardComponent
  Barrierefreies Kanban-Board für Aufgabenverwaltung nach WCAG 2.1 AA Standards
  Unterstützt Drag & Drop zwischen den Spalten, Keyboard-Navigation und Screen Reader
-->
<main class="board" 
      role="main" 
      aria-label="Aufgaben-Board" 
      (click)="closeMobileMenu()">
  
  <!-- Success Message -->
  <div
    *ngIf="success"
    class="board__success"
    role="alert"
    aria-live="polite">
    {{ success }}
  </div>

  <!-- Board Header mit Navigation und Aktionen -->
  <header class="board__header" role="banner">
    <h1 class="board__title" id="board-title">Board</h1>
    <button class="board__add-task-btn" 
            type="button" 
            (click)="navigateToAddTask()"
            aria-label="Neue Aufgabe erstellen"
            aria-describedby="board-title">
      <img src="/assets/img/addTask_icon.png" alt="" role="presentation" aria-hidden="true">
      <span>Add Task</span>
    </button>
  </header>

  <!-- Loading State mit Screen Reader Support -->
  <div *ngIf="isLoading" 
       class="board__loading" 
       role="status" 
       aria-live="polite" 
       aria-label="Aufgaben werden geladen">
    <p>Lade Aufgaben...</p>
  </div>

  <!-- Error Message mit Screen Reader Support -->
  <div *ngIf="error" 
       class="board__error" 
       role="alert" 
       aria-live="assertive">
    <p>{{ error }}</p>
    <button type="button" 
            (click)="loadData()" 
            class="board__retry-btn"
            aria-label="Aufgaben erneut laden">
      Erneut versuchen
    </button>
  </div>

  <!-- Kanban Board Spalten mit Accessibility -->
  <div *ngIf="!isLoading && !error" 
       class="board__columns" 
       role="application" 
       aria-label="Kanban Board mit vier Spalten"
       aria-describedby="board-instructions">
    
    <!-- Screen Reader Anweisungen -->
    <div id="board-instructions" class="sr-only">
      Verwenden Sie die Pfeiltasten oder Drag and Drop, um Aufgaben zwischen den Spalten zu verschieben. 
      Drücken Sie Enter oder Leertaste, um eine Aufgabe zu öffnen.
    </div>
    
    <!-- To Do Column -->
    <section class="board__column" 
             role="region" 
             aria-labelledby="todo-title"
             aria-describedby="todo-description">
      <div class="board__column-header">
        <h2 class="board__column-title" id="todo-title">To do</h2>
        <div id="todo-description" class="sr-only">
          Spalte für neue Aufgaben. Enthält {{ todoTasks.length }} Aufgaben.
        </div>
        <button class="board__add-task-column-btn" 
                type="button" 
                (click)="navigateToAddTask()"
                aria-label="Neue Aufgabe zur To-do Spalte hinzufügen">
          <img src="/assets/img/addTask_icon.png" 
               alt="" 
               role="presentation" 
               aria-hidden="true"
               class="board__add-icon">
        </button>
      </div>
      
      <div class="board__drop-zone"
           cdkDropList
           id="todo-list"
           [cdkDropListData]="todoTasks"
           [cdkDropListConnectedTo]="['inprogress-list', 'awaitfeedback-list', 'done-list']"
           (cdkDropListDropped)="onTaskDrop($event)"
           role="listbox"
           aria-label="To-do Aufgaben"
           [attr.aria-describedby]="todoTasks.length === 0 ? 'todo-empty' : null">
        
        <!-- Task Cards using Template -->
        <div *ngFor="let task of todoTasks; trackBy: trackByTaskId"
             class="board__task-card"
             [cdkDragDisabled]="isMobileView"
             cdkDrag
             (cdkDragStarted)="onDragStarted()"
             (cdkDragEnded)="onDragEnded()"
             (click)="openTaskDetail(task); $event.stopPropagation()"
             (keydown.enter)="openTaskDetail(task)"
             (keydown.space)="openTaskDetail(task); $event.preventDefault()"
             role="option"
             tabindex="0"
             [attr.aria-label]="'Aufgabe: ' + task.title + ', Priorität: ' + task.priority + ', Fällig: ' + (task.dueDate | date:'dd.MM.yyyy')"
             [attr.aria-describedby]="'task-' + task.id + '-desc'">
          <ng-container *ngTemplateOutlet="taskCardContentTemplate; context: { task: task }"></ng-container>
        </div>
        
        <!-- Empty State -->
        <div *ngIf="todoTasks.length === 0" 
             class="board__empty-state"
             id="todo-empty"
             role="status"
             aria-live="polite">
          <p>Keine Aufgaben</p>
        </div>
      </div>
    </section>

    <!-- In Progress Column -->
    <section class="board__column" 
             role="region" 
             aria-labelledby="inprogress-title"
             aria-describedby="inprogress-description">
      <div class="board__column-header">
        <h2 class="board__column-title" id="inprogress-title">In progress</h2>
        <div id="inprogress-description" class="sr-only">
          Spalte für Aufgaben in Bearbeitung. Enthält {{ inProgressTasks.length }} Aufgaben.
        </div>
        <button class="board__add-task-column-btn" 
                type="button" 
                (click)="navigateToAddTask()"
                aria-label="Neue Aufgabe zur In Progress Spalte hinzufügen">
          <img src="/assets/img/addTask_icon.png" 
               alt="" 
               role="presentation" 
               aria-hidden="true"
               class="board__add-icon">
        </button>
      </div>
      
      <div class="board__drop-zone"
           cdkDropList
           id="inprogress-list"
           [cdkDropListData]="inProgressTasks"
           [cdkDropListConnectedTo]="['todo-list', 'awaitfeedback-list', 'done-list']"
           (cdkDropListDropped)="onTaskDrop($event)"
           role="listbox"
           aria-label="In Progress Aufgaben"
           [attr.aria-describedby]="inProgressTasks.length === 0 ? 'inprogress-empty' : null">
        
        <!-- Task Cards using Template -->
        <div *ngFor="let task of inProgressTasks; trackBy: trackByTaskId"
             class="board__task-card"
             [cdkDragDisabled]="isMobileView"
             cdkDrag
             (cdkDragStarted)="onDragStarted()"
             (cdkDragEnded)="onDragEnded()"
             (click)="openTaskDetail(task); $event.stopPropagation()"
             (keydown.enter)="openTaskDetail(task)"
             (keydown.space)="openTaskDetail(task); $event.preventDefault()"
             role="option"
             tabindex="0"
             [attr.aria-label]="'Aufgabe: ' + task.title + ', Priorität: ' + task.priority + ', Fällig: ' + (task.dueDate | date:'dd.MM.yyyy')"
             [attr.aria-describedby]="'task-' + task.id + '-desc'">
          <ng-container *ngTemplateOutlet="taskCardContentTemplate; context: { task: task }"></ng-container>
        </div>
        
        <!-- Empty State -->
        <div *ngIf="inProgressTasks.length === 0" 
             class="board__empty-state"
             id="inprogress-empty"
             role="status"
             aria-live="polite">
          <p>Keine Aufgaben</p>
        </div>
      </div>
    </section>

    <!-- Await Feedback Column -->
    <section class="board__column" 
             role="region" 
             aria-labelledby="awaitfeedback-title"
             aria-describedby="awaitfeedback-description">
      <div class="board__column-header">
        <h2 class="board__column-title" id="awaitfeedback-title">Await feedback</h2>
        <div id="awaitfeedback-description" class="sr-only">
          Spalte für Aufgaben, die auf Feedback warten. Enthält {{ awaitFeedbackTasks.length }} Aufgaben.
        </div>
        <button class="board__add-task-column-btn" 
                type="button" 
                (click)="navigateToAddTask()"
                aria-label="Neue Aufgabe zur Await Feedback Spalte hinzufügen">
          <img src="/assets/img/addTask_icon.png" 
               alt="" 
               role="presentation" 
               aria-hidden="true"
               class="board__add-icon">
        </button>
      </div>
      
      <div class="board__drop-zone"
           cdkDropList
           id="awaitfeedback-list"
           [cdkDropListData]="awaitFeedbackTasks"
           [cdkDropListConnectedTo]="['todo-list', 'inprogress-list', 'done-list']"
           (cdkDropListDropped)="onTaskDrop($event)"
           role="listbox"
           aria-label="Await Feedback Aufgaben"
           [attr.aria-describedby]="awaitFeedbackTasks.length === 0 ? 'awaitfeedback-empty' : null">
        
        <!-- Task Cards using Template -->
        <div *ngFor="let task of awaitFeedbackTasks; trackBy: trackByTaskId"
             class="board__task-card"
             [cdkDragDisabled]="isMobileView"
             cdkDrag
             (cdkDragStarted)="onDragStarted()"
             (cdkDragEnded)="onDragEnded()"
             (click)="openTaskDetail(task); $event.stopPropagation()"
             (keydown.enter)="openTaskDetail(task)"
             (keydown.space)="openTaskDetail(task); $event.preventDefault()"
             role="option"
             tabindex="0"
             [attr.aria-label]="'Aufgabe: ' + task.title + ', Priorität: ' + task.priority + ', Fällig: ' + (task.dueDate | date:'dd.MM.yyyy')"
             [attr.aria-describedby]="'task-' + task.id + '-desc'">
          <ng-container *ngTemplateOutlet="taskCardContentTemplate; context: { task: task }"></ng-container>
        </div>
        
        <!-- Empty State -->
        <div *ngIf="awaitFeedbackTasks.length === 0" 
             class="board__empty-state"
             id="awaitfeedback-empty"
             role="status"
             aria-live="polite">
          <p>Keine Aufgaben</p>
        </div>
      </div>
    </section>

    <!-- Done Column -->
    <section class="board__column" 
             role="region" 
             aria-labelledby="done-title"
             aria-describedby="done-description">
      <div class="board__column-header">
        <h2 class="board__column-title" id="done-title">Done</h2>
        <div id="done-description" class="sr-only">
          Spalte für abgeschlossene Aufgaben. Enthält {{ doneTasks.length }} Aufgaben.
        </div>
        <button class="board__add-task-column-btn" 
                type="button" 
                (click)="navigateToAddTask()"
                aria-label="Neue Aufgabe zur Done Spalte hinzufügen">
          <img src="/assets/img/addTask_icon.png" 
               alt="" 
               role="presentation" 
               aria-hidden="true"
               class="board__add-icon">
        </button>
      </div>
      
      <div class="board__drop-zone"
           cdkDropList
           id="done-list"
           [cdkDropListData]="doneTasks"
           [cdkDropListConnectedTo]="['todo-list', 'inprogress-list', 'awaitfeedback-list']"
           (cdkDropListDropped)="onTaskDrop($event)"
           role="listbox"
           aria-label="Abgeschlossene Aufgaben"
           [attr.aria-describedby]="doneTasks.length === 0 ? 'done-empty' : null">
        
        <!-- Task Cards using Template -->
        <div *ngFor="let task of doneTasks; trackBy: trackByTaskId"
             class="board__task-card"
             [cdkDragDisabled]="isMobileView"
             cdkDrag
             (cdkDragStarted)="onDragStarted()"
             (cdkDragEnded)="onDragEnded()"
             (click)="openTaskDetail(task); $event.stopPropagation()"
             (keydown.enter)="openTaskDetail(task)"
             (keydown.space)="openTaskDetail(task); $event.preventDefault()"
             role="option"
             tabindex="0"
             [attr.aria-label]="'Aufgabe: ' + task.title + ', Priorität: ' + task.priority + ', Fällig: ' + (task.dueDate | date:'dd.MM.yyyy')"
             [attr.aria-describedby]="'task-' + task.id + '-desc'">
          <ng-container *ngTemplateOutlet="taskCardContentTemplate; context: { task: task }"></ng-container>
        </div>
        
        <!-- Empty State -->
        <div *ngIf="doneTasks.length === 0" 
             class="board__empty-state"
             id="done-empty"
             role="status"
             aria-live="polite">
          <p>Keine Aufgaben</p>
        </div>
      </div>
    </section>

  </div>
</main>

<!-- Task Detail Modal mit WCAG 2.1 AA Compliance -->
<div *ngIf="showTaskDetail && selectedTask" 
     class="board__modal-overlay" 
     role="dialog"
     aria-modal="true"
     aria-labelledby="modal-title"
     aria-describedby="modal-description"
     (click)="closeTaskDetail()"
     (keydown.escape)="handleEscapeKey()">
  
  <div class="board__task-detail-modal" 
       (click)="handleModalClick($event)"
       role="document">
    
    <!-- Modal Header -->
    <header class="board__modal-header">
      <div class="board__task-category-detail" 
           [style.background-color]="getCategoryColor(selectedTask.category)"
           role="status"
           [attr.aria-label]="'Kategorie: ' + selectedTask.category">
        {{ selectedTask.category }}
      </div>
      <button class="board__modal-close-btn" 
              type="button" 
              (click)="closeTaskDetail()"
              aria-label="Task Detail Dialog schließen"
              autofocus>
        <img src="/assets/img/close_small_white_icon.png" 
             alt="" 
             role="presentation" 
             aria-hidden="true">
      </button>
    </header>

    <!-- Modal Content -->
    <div class="board__modal-content" role="main">
      
      <!-- VIEW MODE: Task Title -->
      <h1 *ngIf="!isEditMode" 
          class="board__modal-title" 
          id="modal-title">{{ selectedTask.title }}</h1>
      
      <!-- EDIT MODE: Task Title Input -->
      <div *ngIf="isEditMode" class="board__edit-field">
        <label for="edit-title" class="board__edit-label">Titel</label>
        <input 
          id="edit-title"
          type="text" 
          [(ngModel)]="editTask!.title"
          class="board__edit-input board__edit-title"
          placeholder="Aufgaben-Titel eingeben">
      </div>
      
      <!-- VIEW MODE: Task Description -->
      <div *ngIf="!isEditMode && selectedTask.description" 
           class="board__modal-description" 
           id="modal-description">
        <h2 class="sr-only">Beschreibung</h2>
        <p>{{ selectedTask.description }}</p>
      </div>
      
      <!-- EDIT MODE: Task Description -->
      <div *ngIf="isEditMode" class="board__edit-field">
        <label for="edit-description" class="board__edit-label">Beschreibung</label>
        <textarea 
          id="edit-description"
          [(ngModel)]="editTask!.description"
          class="board__edit-textarea"
          placeholder="Beschreibung eingeben..."
          rows="3"></textarea>
      </div>
      
      <!-- Task Details Grid -->
      <div class="board__modal-details" role="group" aria-label="Aufgaben-Details">
        
        <!-- VIEW MODE: Due Date -->
        <div *ngIf="!isEditMode" class="board__detail-item">
          <span class="board__detail-label" id="due-date-label">Fälligkeitsdatum:</span>
          <span class="board__detail-value" 
                aria-labelledby="due-date-label"
                [attr.aria-label]="'Fällig am ' + (selectedTask.dueDate | date:'dd.MM.yyyy')">
            {{ selectedTask.dueDate | date:'dd.MM.yyyy' }}
          </span>
        </div>
        
        <!-- EDIT MODE: Due Date -->
        <div *ngIf="isEditMode" class="board__detail-item">
          <label for="edit-due-date" class="board__edit-label">Fälligkeitsdatum:</label>
          <input 
            id="edit-due-date"
            type="date" 
            [(ngModel)]="editTask!.dueDate"
            class="board__edit-input">
        </div>
        
        <!-- VIEW MODE: Priority -->
        <div *ngIf="!isEditMode" class="board__detail-item">
          <span class="board__detail-label" id="priority-label">Priorität:</span>
          <div class="board__priority-detail" 
               role="group" 
               aria-labelledby="priority-label"
               [attr.aria-label]="selectedTask.priority + ' Priorität'">
            <img [src]="getPriorityIcon(selectedTask.priority)" 
                 [alt]=""
                 role="presentation"
                 aria-hidden="true"
                 class="board__priority-icon-detail">
            <span class="board__detail-value">{{ selectedTask.priority }}</span>
          </div>
        </div>
        
        <!-- EDIT MODE: Priority -->
        <div *ngIf="isEditMode" class="board__detail-item">
          <label for="edit-priority" class="board__edit-label">Priorität:</label>
          <select 
            id="edit-priority"
            [(ngModel)]="editTask!.priority"
            class="board__edit-select">
            <option value="low">Niedrig</option>
            <option value="medium">Mittel</option>
            <option value="urgent">Hoch</option>
          </select>
        </div>
        
        <!-- VIEW MODE: Assigned Contacts -->
        <div *ngIf="!isEditMode" class="board__detail-item">
          <span class="board__detail-label" id="assigned-label">Zugewiesen an:</span>
          <div class="board__assigned-contacts" 
               role="group" 
               aria-labelledby="assigned-label">
            <div *ngFor="let contactId of selectedTask.assignedTo" 
                 class="board__contact-detail"
                 role="group"
                 [attr.aria-label]="'Kontakt: ' + getContactName(contactId)">
              <div class="board__contact-avatar-detail"
                   [style.background-color]="getContactColor(contactId)"
                   [attr.aria-label]="'Avatar von ' + getContactName(contactId)"
                   role="img">
                {{ getContactInitials(contactId) }}
              </div>
              <span class="board__contact-name">{{ getContactName(contactId) }}</span>
            </div>
          </div>
        </div>
        
        <!-- EDIT MODE: Assigned Contacts -->
        <div *ngIf="isEditMode" class="board__detail-item">
          <label class="board__edit-label">Zugewiesen an:</label>
          
          <!-- Contact Selector -->
          <div class="board__contacts-selector-wrapper">
            <div class="board__select-row">
              <input
                id="edit-contact-search"
                class="board__edit-contact-input"
                type="text"
                placeholder="Select contacts to assign"
                [(ngModel)]="editContactSearch"
                name="editContactSearch"
                (focus)="openEditContacts()"
                (ngModelChange)="filterEditContacts()"
                [attr.aria-expanded]="showEditContactsDropdown"
                aria-haspopup="listbox"
                role="combobox"
                autocomplete="off">
              <button
                type="button"
                class="board__contact-select-button"
                [attr.aria-label]="showEditContactsDropdown ? 'Close contact selection' : 'Open contact selection'"
                (click)="toggleEditContacts($event)"
                (keydown.enter)="toggleEditContacts($event)"
                (keydown.space)="$event.preventDefault(); toggleEditContacts($event)">
                <img
                  class="board__select-icon"
                  [src]="showEditContactsDropdown ? '/assets/img/close_dropdown_icon.png' : '/assets/img/open_dropdown_icon.png'"
                  alt=""
                  role="presentation">
              </button>
            </div>

            <!-- Contact Dropdown -->
            <div *ngIf="showEditContactsDropdown"
                 class="board__assign-dropdown"
                 role="listbox"
                 aria-label="Available contacts"
                 (click)="$event.stopPropagation()"
                 (keydown.escape)="closeEditContacts()">
              <div class="board__assign-dropdown-list">
                <div *ngFor="let contact of filteredEditContacts; trackBy: trackByContact"
                     class="board__assign-dropdown-item"
                     [class.selected]="isEditContactAssigned(contact.id)"
                     (click)="toggleEditContactSelection(contact)"
                     role="option"
                     [attr.aria-selected]="isEditContactAssigned(contact.id)"
                     [attr.aria-label]="contact.name + (isEditContactAssigned(contact.id) ? ' (selected)' : '')"
                     tabindex="0"
                     (keydown.enter)="toggleEditContactSelection(contact)"
                     (keydown.space)="$event.preventDefault(); toggleEditContactSelection(contact)">
                  <div class="board__assign-dropdown-avatar"
                       [style.background]="contact.color || '#4589ff'"
                       aria-hidden="true">
                    {{ getContactInitials(contact.id!) }}
                  </div>
                  <div class="board__assign-dropdown-name">{{ contact.name }}</div>
                  <img class="board__assign-dropdown-check"
                       [src]="isEditContactAssigned(contact.id) ? '/assets/img/checked_checkbox_icon.png' : '/assets/img/unchecked_checkbox_icon.png'"
                       alt=""
                       role="presentation">
                </div>
              </div>
            </div>

            <!-- Selected Contacts Display -->
            <div *ngIf="editTask!.assignedTo && editTask!.assignedTo.length > 0"
                 class="board__selected-contacts-row"
                 role="group"
                 aria-label="Selected contacts">
              <ng-container *ngFor="let contactId of editTask!.assignedTo.slice(0, 3); let i = index">
                <div *ngIf="getEditContactById(contactId) as contact"
                     class="board__selected-contact-avatar"
                     [style.background]="contact.color || '#4589ff'"
                     [attr.aria-label]="contact.name"
                     role="img">
                  {{ getContactInitials(contactId) }}
                </div>
              </ng-container>
              <div *ngIf="editTask!.assignedTo.length > 3"
                   class="board__selected-contact-avatar board__selected-contact-avatar--more"
                   [attr.aria-label]="editTask!.assignedTo.length - 3 + ' more contacts selected'"
                   role="img">
                +{{ editTask!.assignedTo.length - 3 }}
              </div>
            </div>
          </div>
        </div>
        
        <!-- EDIT MODE: Category -->
        <div *ngIf="isEditMode" class="board__detail-item">
          <label for="edit-category" class="board__edit-label">Kategorie:</label>
          <input 
            id="edit-category"
            type="text" 
            [(ngModel)]="editTask!.category"
            class="board__edit-input"
            placeholder="Kategorie eingeben">
        </div>
        
      </div>
      
      <!-- VIEW MODE: Subtasks Section -->
      <div *ngIf="!isEditMode && selectedTask.subtasks && selectedTask.subtasks.length > 0" 
           class="board__subtasks-section"
           role="group"
           aria-labelledby="subtasks-title">
        <h2 class="board__subtasks-title" id="subtasks-title">
          Subtasks ({{ getCompletedSubtasksCount(selectedTask) }}/{{ getTotalSubtasksCount(selectedTask) }})
        </h2>
        <ul class="board__subtasks-list" 
            role="list"
            aria-label="Liste der Teilaufgaben">
          <li *ngFor="let subtask of selectedTask.subtasks; let i = index" 
              class="board__subtask-item"
              role="listitem">
            <label class="board__subtask-label" 
                   [attr.for]="'subtask-' + i">
              <input type="checkbox" 
                     class="board__subtask-checkbox"
                     [id]="'subtask-' + i"
                     [checked]="isSubtaskCompleted(subtask)"
                     (change)="toggleSubtask(i, $event)"
                     [attr.aria-describedby]="'subtask-text-' + i">
              <span class="board__subtask-text" 
                    [id]="'subtask-text-' + i"
                    [class.board__subtask-text--completed]="isSubtaskCompleted(subtask)"
                    [attr.aria-label]="(isSubtaskCompleted(subtask) ? 'Erledigt: ' : 'Offen: ') + subtask">
                {{ subtask }}
              </span>
            </label>
          </li>
        </ul>
      </div>
      
      <!-- EDIT MODE: Subtasks Section -->
      <div *ngIf="isEditMode" 
           class="board__subtasks-section"
           role="group"
           aria-labelledby="edit-subtasks-title">
        <div class="board__edit-subtasks-header">
          <h2 class="board__subtasks-title" id="edit-subtasks-title">
            Subtasks
          </h2>
          <button 
            type="button"
            class="board__add-subtask-btn"
            (click)="addSubtaskToEdit()"
            aria-label="Neue Subtask hinzufügen">
            + Subtask hinzufügen
          </button>
        </div>
        <ul class="board__edit-subtasks-list" 
            role="list"
            aria-label="Bearbeitbare Liste der Teilaufgaben">
          <li *ngFor="let subtask of editTask!.subtasks || []; let i = index" 
              class="board__edit-subtask-item"
              role="listitem">
            <input 
              type="text"
              [(ngModel)]="editTask!.subtasks![i]"
              class="board__edit-subtask-input"
              placeholder="Subtask eingeben...">
            <button 
              type="button"
              class="board__remove-subtask-btn"
              (click)="removeSubtaskFromEdit(i)"
              aria-label="Subtask entfernen">
              ✕
            </button>
          </li>
          <li *ngIf="!editTask!.subtasks || editTask!.subtasks.length === 0" 
              class="board__no-subtasks">
            <em>Keine Subtasks vorhanden. Klicken Sie auf "+ Subtask hinzufügen"</em>
          </li>
        </ul>
      </div>
      
    </div>
    
    <!-- Modal Actions -->
    <footer class="board__modal-actions" 
            role="group" 
            aria-label="Aufgaben-Aktionen">
      
      <!-- VIEW MODE Actions -->
      <ng-container *ngIf="!isEditMode">
        <button class="board__action-btn board__action-btn--delete" 
                type="button" 
                (click)="deleteTask(selectedTask)"
                aria-label="Aufgabe löschen"
                aria-describedby="delete-description">
          <img src="/assets/img/delete_icon_blue.png" 
               alt="" 
               role="presentation" 
               aria-hidden="true">
          <span>Löschen</span>
          <span id="delete-description" class="sr-only">
            Diese Aktion löscht die Aufgabe dauerhaft
          </span>
        </button>
        <button class="board__action-btn board__action-btn--edit" 
                type="button" 
                (click)="startEditMode(selectedTask)"
                aria-label="Aufgabe bearbeiten"
                aria-describedby="edit-description">
          <img src="/assets/img/edit_icon_blue.png" 
               alt="" 
               role="presentation" 
               aria-hidden="true">
          <span>Bearbeiten</span>
          <span id="edit-description" class="sr-only">
            Öffnet das Bearbeitungsformular für diese Aufgabe
          </span>
        </button>
      </ng-container>
      
      <!-- EDIT MODE Actions -->
      <ng-container *ngIf="isEditMode">
        <button class="board__action-btn board__action-btn--cancel" 
                type="button" 
                (click)="cancelEditMode(); $event.stopPropagation()"
                aria-label="Bearbeitung abbrechen"
                aria-describedby="cancel-description">
          <img src="/assets/img/close_small_white_icon.png" 
               alt="" 
               role="presentation" 
               aria-hidden="true">
          <span>Abbrechen</span>
          <span id="cancel-description" class="sr-only">
            Bricht die Bearbeitung ab und kehrt zur Ansicht zurück
          </span>
        </button>
        <button class="board__action-btn board__action-btn--save" 
                type="button" 
                (click)="saveEditedTask(); $event.stopPropagation()"
                aria-label="Änderungen speichern"
                aria-describedby="save-description">
          <img src="/assets/img/check_blue_icon.png" 
               alt="" 
               role="presentation" 
               aria-hidden="true">
          <span>Speichern</span>
          <span id="save-description" class="sr-only">
            Speichert die Änderungen an der Aufgabe
          </span>
        </button>
      </ng-container>
    </footer>
    
  </div>
</div>

<!-- ===============================
     Reusable Task Card Template mit WCAG 2.1 AA
     =============================== -->
<ng-template #taskCardContentTemplate let-task="task">
    <!-- Versteckte Beschreibung für Screen Reader -->
    <div [id]="'task-' + task.id + '-desc'" class="sr-only">
      Aufgabe in {{ task.status === 'todo' ? 'To-do' : task.status === 'inprogress' ? 'In Progress' : task.status === 'awaitfeedback' ? 'Await Feedback' : 'Done' }} Spalte.
      {{ task.description ? 'Beschreibung: ' + task.description + '.' : '' }}
      {{ task.assignedTo.length > 0 ? 'Zugewiesen an ' + task.assignedTo.length + ' Person' + (task.assignedTo.length === 1 ? '' : 'en') + '.' : '' }}
      {{ getTotalSubtasksCount(task) > 0 ? getCompletedSubtasksCount(task) + ' von ' + getTotalSubtasksCount(task) + ' Teilaufgaben erledigt.' : '' }}
    </div>

    <!-- Category Badge -->
    <div class="board__task-category" 
         [style.background-color]="getCategoryColor(task.category)"
         role="status"
         [attr.aria-label]="'Kategorie: ' + task.category">
      {{ task.category }}
    </div>
    
    <!-- Task Header with Title and Mobile Menu -->
    <header class="board__task-header">
      <h3 class="board__task-title">{{ task.title }}</h3>
      
      <!-- Mobile Menu Container -->
      <div class="board__mobile-menu-container">
        <button class="board__mobile-menu-btn"
                type="button"
                (click)="toggleMobileMenu(task.id); $event.stopPropagation()"
                [attr.aria-label]="'Task verschieben: ' + task.title"
                [attr.aria-expanded]="showMobileMenu === task.id"
                [attr.aria-controls]="'mobile-menu-' + task.id">
          <img src="/assets/img/swap_icon_blue.png" 
               alt="" 
               role="presentation" 
               aria-hidden="true">
        </button>
        
        <!-- Mobile Menu -->
        <nav *ngIf="showMobileMenu === task.id" 
             class="board__mobile-menu"
             [id]="'mobile-menu-' + task.id"
             role="menu"
             aria-label="Task verschieben Optionen">
          <button *ngFor="let option of getAvailableStatusOptions(task.status)"
                  type="button"
                  class="board__mobile-menu-item"
                  role="menuitem"
                  (click)="moveTaskViaMobile(task, option.status); $event.stopPropagation()"
                  [attr.aria-label]="'Task nach ' + option.label + ' verschieben'">
            <img [src]="option.icon" 
                 alt="" 
                 role="presentation" 
                 aria-hidden="true"
                 class="board__menu-icon">
            <span>{{ option.label }}</span>
          </button>
        </nav>
      </div>
    </header>
    
    <!-- Task Description -->
    <div *ngIf="task.description" class="board__task-description">
      <p>{{ task.description }}</p>
    </div>
    
    <!-- Subtasks Progress -->
    <div *ngIf="getTotalSubtasksCount(task) > 0" 
         class="board__task-progress"
         role="progressbar"
         [attr.aria-valuenow]="getCompletedSubtasksCount(task)"
         [attr.aria-valuemin]="0"
         [attr.aria-valuemax]="getTotalSubtasksCount(task)"
         [attr.aria-label]="getCompletedSubtasksCount(task) + ' von ' + getTotalSubtasksCount(task) + ' Teilaufgaben erledigt'">
      <div class="board__progress-bar" aria-hidden="true">
        <div class="board__progress-fill" 
             [style.width.%]="(getCompletedSubtasksCount(task) / getTotalSubtasksCount(task)) * 100">
        </div>
      </div>
      <span class="board__progress-text" aria-hidden="true">
        {{ getCompletedSubtasksCount(task) }}/{{ getTotalSubtasksCount(task) }} Subtasks
      </span>
    </div>
    
    <!-- Task Footer -->
    <footer class="board__task-footer">
      <!-- Assigned Contacts -->
      <div class="board__task-contacts" 
           role="group" 
           [attr.aria-label]="'Zugewiesene Kontakte: ' + task.assignedTo.length + (task.assignedTo.length === 1 ? ' Person' : ' Personen')">
        <div *ngFor="let contactId of task.assignedTo.slice(0, 3); trackBy: trackByContactId" 
             class="board__contact-avatar"
             [style.background-color]="getContactColor(contactId)"
             [attr.title]="getContactName(contactId)"
             [attr.aria-label]="'Avatar: ' + getContactName(contactId)"
             role="img">
          {{ getContactInitials(contactId) }}
        </div>
        <div *ngIf="task.assignedTo.length > 3" 
             class="board__contact-avatar board__contact-avatar--more"
             [attr.title]="'Und ' + (task.assignedTo.length - 3) + ' weitere'"
             [attr.aria-label]="'Und ' + (task.assignedTo.length - 3) + ' weitere Kontakte'"
             role="img">
          +{{ task.assignedTo.length - 3 }}
        </div>
      </div>
      
      <!-- Priority Icon -->
      <div class="board__task-priority" 
           [attr.aria-label]="task.priority + ' Priorität'"
           role="img">
        <img [src]="getPriorityIcon(task.priority)" 
             [alt]=""
             role="presentation"
             aria-hidden="true"
             class="board__priority-icon">
      </div>
    </footer>
</ng-template>
