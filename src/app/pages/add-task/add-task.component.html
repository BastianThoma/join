<main class="add-task" role="main" aria-labelledby="page-title">
  <h1 id="page-title" class="sr-only">Create New Task</h1>
  
  <form 
    class="add-task__form" 
    (ngSubmit)="onSubmit()" 
    novalidate
    aria-label="Task creation form"
  >
    <!-- Success Message -->
    <div 
      *ngIf="success" 
      class="add-task__success"
      role="alert"
      aria-live="polite"
    >
      {{ success }}
    </div>

    <!-- Task Title Section -->
    <section class="add-task__section" aria-labelledby="title-label">
      <label id="title-label" for="task-title" class="add-task__label">
        Title <span class="add-task__required" aria-label="required">*</span>
      </label>
      <input
        id="task-title"
        class="add-task__title"
        type="text"
        placeholder="Enter a title"
        required
        [(ngModel)]="title"
        name="title"
        aria-describedby="title-error"
        [attr.aria-invalid]="error && !title.trim() ? 'true' : 'false'"
      />
      <div 
        id="title-error" 
        *ngIf="error && !title.trim()" 
        class="add-task__error" 
        role="alert"
        aria-live="polite"
      >
        Title is required.
      </div>
    </section>

    <!-- Task Description Section -->
    <section class="add-task__section" aria-labelledby="description-label">
      <label id="description-label" for="task-description" class="add-task__label">
        Description <span class="add-task__optional">(optional)</span>
      </label>
      <textarea
        id="task-description"
        class="add-task__description"
        placeholder="Enter a Description"
        [(ngModel)]="description"
        name="description"
        rows="4"
        aria-describedby="description-hint"
      ></textarea>
      <div id="description-hint" class="sr-only">
        Provide additional details about the task
      </div>
    </section>

    <!-- Due Date Section -->
    <section class="add-task__section" aria-labelledby="date-label">
      <label id="date-label" for="task-date" class="add-task__label">
        Due date <span class="add-task__required" aria-label="required">*</span>
      </label>
      <div class="add-task__date-row">
        <input
          id="task-date"
          #dueInput
          class="add-task__date"
          type="date"
          [(ngModel)]="dueDate"
          name="dueDate"
          required
          aria-describedby="date-error"
          [attr.aria-invalid]="error && !dueDate.trim() ? 'true' : 'false'"
        />
        <button
          type="button"
          class="add-task__date-button"
          aria-label="Open calendar picker"
          (click)="openDatepicker(dueInput)"
        >
          <img
            class="add-task__date-icon"
            src="/assets/img/datepicker_calendar_icon.png"
            alt=""
            role="presentation"
          />
        </button>
      </div>
      <div 
        id="date-error" 
        *ngIf="error && !dueDate.trim()" 
        class="add-task__error" 
        role="alert"
        aria-live="polite"
      >
        Due date is required.
      </div>
    </section>

    <!-- Priority Section -->
    <section class="add-task__section" aria-labelledby="priority-label">
      <label id="priority-label" class="add-task__label">Priority</label>
      <fieldset class="add-task__priority-fieldset" aria-describedby="priority-hint">
        <legend class="sr-only">Select task priority level</legend>
        <div id="priority-hint" class="sr-only">
          Choose between urgent, medium, or low priority
        </div>
        
        <div class="add-task__priority-row" role="radiogroup" aria-labelledby="priority-label">
          <button
            type="button"
            class="add-task__priority add-task__priority--urgent"
            [class.add-task__priority--active]="priority === 'urgent'"
            (click)="setPriority('urgent')"
            (mouseenter)="setHover('urgent')"
            (mouseleave)="setHover(null)"
            role="radio"
            [attr.aria-checked]="priority === 'urgent'"
            aria-label="Urgent priority"
          >
            Urgent
            <img 
              [src]="priority === 'urgent' || hoverPriority === 'urgent' ? '/assets/img/urgent_prio_icon_white.png' : '/assets/img/urgent_prio_icon_red.png'" 
              alt="" 
              role="presentation"
            />
          </button>
          
          <button
            type="button"
            class="add-task__priority add-task__priority--medium"
            [class.add-task__priority--active]="priority === 'medium'"
            (click)="setPriority('medium')"
            (mouseenter)="setHover('medium')"
            (mouseleave)="setHover(null)"
            role="radio"
            [attr.aria-checked]="priority === 'medium'"
            aria-label="Medium priority"
          >
            Medium
            <img 
              [src]="priority === 'medium' || hoverPriority === 'medium' ? '/assets/img/medium_prio_icon_white.png' : '/assets/img/medium_prio_icon_orange.png'" 
              alt="" 
              role="presentation"
            />
          </button>
          
          <button
            type="button"
            class="add-task__priority add-task__priority--low"
            [class.add-task__priority--active]="priority === 'low'"
            (click)="setPriority('low')"
            (mouseenter)="setHover('low')"
            (mouseleave)="setHover(null)"
            role="radio"
            [attr.aria-checked]="priority === 'low'"
            aria-label="Low priority"
          >
            Low
            <img 
              [src]="priority === 'low' || hoverPriority === 'low' ? '/assets/img/low_prio_icon_white.png' : '/assets/img/low_prio_icon_green.png'" 
              alt="" 
              role="presentation"
            />
          </button>
        </div>
      </fieldset>
    </section>

    <!-- Assigned To Section -->
    <section class="add-task__section" aria-labelledby="contacts-label">
      <label id="contacts-label" class="add-task__label">
        Assigned to <span class="add-task__optional">(optional)</span>
      </label>
      
      <div class="contacts-selector-wrapper" #contactsSelectorWrapper>
        <div class="add-task__select-row">
          <input
            id="contact-search"
            class="add-task__select"
            type="text"
            placeholder="Select contacts to assign"
            [(ngModel)]="contactSearch"
            name="contactSearch"
            (focus)="openContacts()"
            (ngModelChange)="filterContacts()"
            [attr.aria-expanded]="showContactsDropdown"
            aria-haspopup="listbox"
            aria-describedby="contacts-hint"
            role="combobox"
            autocomplete="off"
          />
          <button
            type="button"
            class="add-task__select-button"
            [attr.aria-label]="showContactsDropdown ? 'Close contact selection' : 'Open contact selection'"
            (click)="toggleContacts($event)"
          >
            <img 
              class="add-task__select-icon" 
              [src]="showContactsDropdown ? '/assets/img/close_dropdown_icon.png' : '/assets/img/open_dropdown_icon.png'" 
              alt="" 
              role="presentation"
            />
          </button>
        </div>
        
        <div id="contacts-hint" class="sr-only">
          Type to search contacts or click to see all available contacts
        </div>

        <div 
          *ngIf="showContactsDropdown" 
          class="assign-dropdown" 
          role="listbox"
          aria-label="Available contacts"
          (click)="$event.stopPropagation()"
        >
          <div class="assign-dropdown__list">
            <div 
              *ngFor="let c of filteredContacts; trackBy: trackByContactId" 
              class="assign-dropdown__item" 
              [class.selected]="isAssigned(c.id)" 
              (click)="toggleContactSelection(c)"
              role="option"
              [attr.aria-selected]="isAssigned(c.id)"
              [attr.aria-label]="c.name + (isAssigned(c.id) ? ' (selected)' : '')"
              tabindex="0"
              (keydown.enter)="toggleContactSelection(c)"
              (keydown.space)="$event.preventDefault(); toggleContactSelection(c)"
            >
              <div 
                class="assign-dropdown__avatar" 
                [style.background]="c.color || '#ccc'"
                aria-hidden="true"
              >
                {{ getInitials(c.name) }}
              </div>
              <div class="assign-dropdown__name">{{ c.name }}</div>
              <img 
                class="assign-dropdown__check" 
                [src]="isAssigned(c.id) ? '/assets/img/checked_checkbox_icon.png' : '/assets/img/unchecked_checkbox_icon.png'" 
                alt="" 
                role="presentation"
              />
            </div>
          </div>
        </div>

        <!-- Selected Contacts Display -->
        <div 
          *ngIf="assignedTo.length > 0" 
          class="selected-contacts-row"
          role="group"
          aria-label="Selected contacts"
        >
          <ng-container *ngFor="let id of assignedTo.slice(0,3); let i = index">
            <div 
              *ngIf="getContactById(id) as contact" 
              class="selected-contact-avatar" 
              [style.background]="contact.color || '#ccc'"
              [attr.aria-label]="contact.name"
              role="img"
            >
              {{ getInitials(contact.name) }}
            </div>
          </ng-container>
          <div 
            *ngIf="assignedTo.length > 3" 
            class="selected-contact-avatar selected-contact-avatar--more"
            [attr.aria-label]="(assignedTo.length - 3) + ' more contacts selected'"
            role="img"
          >
            +{{ assignedTo.length - 3 }}
          </div>
        </div>
      </div>
    </section>

    <!-- Category Section -->
    <section class="add-task__section" aria-labelledby="category-label">
      <label id="category-label" class="add-task__label">
        Category <span class="add-task__required" aria-label="required">*</span>
      </label>
      
      <div class="category-picker-row" #categoryPickerWrapper>
        <button
          type="button"
          class="category-picker-display"
          (click)="showCategoryDropdown = !showCategoryDropdown"
          [attr.aria-expanded]="showCategoryDropdown"
          aria-haspopup="listbox"
          [attr.aria-describedby]="category ? null : 'category-placeholder'"
          [attr.aria-invalid]="error && !category.trim() ? 'true' : 'false'"
          role="combobox"
        >
          <span 
            *ngIf="!category" 
            id="category-placeholder"
            class="category-picker-placeholder"
          >
            Select task category
          </span>
          <span 
            *ngIf="category" 
            class="category-picker-value"
            [attr.aria-label]="'Selected category: ' + category"
          >
            {{ category }}
          </span>
          <img
            class="category-picker-arrow"
            [class.open]="showCategoryDropdown"
            src="/assets/img/open_dropdown_icon.png"
            alt=""
            role="presentation"
          />
        </button>

        <div 
          *ngIf="showCategoryDropdown" 
          class="category-picker-dropdown"
          role="listbox"
          aria-label="Category options"
        >
          <div
            class="category-picker-option"
            [class.selected]="category === 'Technical Task'"
            (click)="selectCategory('Technical Task')"
            role="option"
            [attr.aria-selected]="category === 'Technical Task'"
            tabindex="0"
            (keydown.enter)="selectCategory('Technical Task')"
            (keydown.space)="$event.preventDefault(); selectCategory('Technical Task')"
          >
            Technical Task
          </div>
          <div
            class="category-picker-option"
            [class.selected]="category === 'User Story'"
            (click)="selectCategory('User Story')"
            role="option"
            [attr.aria-selected]="category === 'User Story'"
            tabindex="0"
            (keydown.enter)="selectCategory('User Story')"
            (keydown.space)="$event.preventDefault(); selectCategory('User Story')"
          >
            User Story
          </div>
        </div>
      </div>
      
      <div 
        *ngIf="error && !category.trim()" 
        class="add-task__error" 
        role="alert"
        aria-live="polite"
      >
        Category is required.
      </div>
    </section>

    <!-- Subtasks Section -->
    <section class="add-task__section" aria-labelledby="subtasks-label">
      <label id="subtasks-label" class="add-task__label">
        Subtasks <span class="add-task__optional">(optional)</span>
      </label>
      
      <div class="add-task__subtasks-row">
        <!-- Subtask Input -->
        <div class="add-task__select-row" role="group" aria-labelledby="subtasks-label">
          <input
            id="subtask-input"
            #subtaskInput
            class="add-task__select"
            type="text"
            placeholder="Add new subtask"
            [(ngModel)]="newSubtask"
            name="newSubtask"
            (keydown.enter)="addSubtask()"
            [disabled]="editSubtaskIndex !== null"
            (focus)="subtaskInputFocused = true"
            (blur)="subtaskInputFocused = false"
            aria-describedby="subtask-hint"
          />
          <div id="subtask-hint" class="sr-only">
            Press Enter or click the add button to create a new subtask
          </div>
          
          <div class="add-task__select-icons" role="group" aria-label="Subtask actions">
            <button
              *ngIf="!newSubtask && !subtaskInputFocused"
              type="button"
              class="add-task__select-button"
              aria-label="Add new subtask"
              (mousedown)="$event.preventDefault(); addSubtask()"
            >
              <img 
                class="add-task__select-icon" 
                src="/assets/img/add_subtask_blue_icon.png" 
                alt="" 
                role="presentation"
              />
            </button>
            
            <ng-container *ngIf="subtaskInputFocused || newSubtask">
              <button
                type="button"
                class="add-task__select-button"
                aria-label="Clear subtask input"
                (mousedown)="clearSubtaskInput(subtaskInput); $event.preventDefault()"
                style="right: 32px;"
              >
                <img 
                  class="add-task__select-icon" 
                  src="/assets/img/x_delete_blue_icon.png" 
                  alt="" 
                  role="presentation"
                />
              </button>
              
              <button
                type="button"
                class="add-task__select-button"
                aria-label="Add subtask"
                (mousedown)="addSubtaskFromInput(subtaskInput); $event.preventDefault()"
              >
                <img 
                  class="add-task__select-icon" 
                  src="/assets/img/check_blue_icon.png" 
                  alt="" 
                  role="presentation"
                />
              </button>
            </ng-container>
          </div>
        </div>
      </div>
      
      <!-- Subtasks List -->
      <div 
        *ngIf="subtasks.length > 0"
        class="subtasks-list" 
        role="list"
        aria-label="Current subtasks"
      >
        <div 
          *ngFor="let sub of subtasks; let i = index; trackBy: trackBySubtaskIndex" 
          class="subtask-list-item"
          role="listitem"
        >
          <span class="subtask-dot" aria-hidden="true">•</span>
          
          <!-- Display Mode -->
          <ng-container *ngIf="editSubtaskIndex !== i">
            <span class="subtask-text" [attr.aria-label]="'Subtask: ' + sub">{{ sub }}</span>
            <div class="subtask-actions" role="group" [attr.aria-label]="'Actions for subtask: ' + sub">
              <button
                type="button"
                class="subtask-action-button"
                [attr.aria-label]="'Edit subtask: ' + sub"
                (click)="startEditSubtask(i)"
              >
                <img 
                  class="subtask-icon subtask-edit" 
                  src="/assets/img/edit_icon_blue.png" 
                  alt="" 
                  role="presentation"
                />
              </button>
              <button
                type="button"
                class="subtask-action-button"
                [attr.aria-label]="'Delete subtask: ' + sub"
                (click)="removeSubtask(i)"
              >
                <img 
                  class="subtask-icon subtask-delete" 
                  src="/assets/img/delete_icon_blue.png" 
                  alt="" 
                  role="presentation"
                />
              </button>
            </div>
          </ng-container>
          
          <!-- Edit Mode -->
          <ng-container *ngIf="editSubtaskIndex === i">
            <input 
              class="add-task__select subtask-edit-input" 
              type="text" 
              [(ngModel)]="editSubtaskValue" 
              [ngModelOptions]="{standalone: true}"
              (keydown.enter)="confirmEditSubtask()"
              [attr.aria-label]="'Edit subtask: ' + sub"
              #editInput
            />
            <div class="subtask-actions" role="group" aria-label="Edit actions">
              <button
                type="button"
                class="subtask-action-button"
                aria-label="Delete this subtask"
                (click)="removeSubtask(i)"
              >
                <img 
                  class="subtask-icon subtask-clear" 
                  src="/assets/img/delete_icon_blue.png" 
                  alt="" 
                  role="presentation"
                />
              </button>
              <div class="subtask-divider" aria-hidden="true"></div>
              <button
                type="button"
                class="subtask-action-button"
                aria-label="Save changes to subtask"
                (click)="confirmEditSubtask()"
              >
                <img 
                  class="subtask-icon subtask-check" 
                  src="/assets/img/check_blue_icon.png" 
                  alt="" 
                  role="presentation"
                />
              </button>
            </div>
          </ng-container>
        </div>
      </div>
    </section>

    <!-- Form Actions -->
    <div class="add-task__form-actions" role="group" aria-label="Form actions">
      <button 
        type="button" 
        class="add-task__clear-btn"
        (click)="clearForm()"
        aria-describedby="clear-help"
      >
        Clear
        <img src="/assets/img/clear_button_icon.png" alt="" role="presentation" />
      </button>
      <div id="clear-help" class="sr-only">Clear all form fields and start over</div>
      
      <button 
        type="submit" 
        class="add-task__create-btn"
        [disabled]="!title.trim() || !dueDate.trim() || !category.trim()"
        aria-describedby="submit-help"
      >
        Create Task
        <img src="/assets/img/check_small_icon.png" alt="" role="presentation" />
      </button>
      <div id="submit-help" class="sr-only">Create the new task with the provided information</div>
    </div>

    <!-- Form Messages -->
    <div class="add-task__messages" aria-live="polite" role="status">
      <div 
        *ngIf="error && !(!title.trim() || !dueDate.trim() || !category.trim())" 
        class="add-task__error"
        role="alert"
      >
        {{ error }}
      </div>
    </div>
  </form>
</main>
