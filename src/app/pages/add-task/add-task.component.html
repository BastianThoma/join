<div class="add-task">
  <form class="add-task__form" (ngSubmit)="onSubmit()">
    <div *ngIf="success" class="add-task__success">{{ success }}</div>
    <input
      class="add-task__title"
      type="text"
      placeholder="Enter a title"
      required
      [(ngModel)]="title"
      name="title"
    />
    <div *ngIf="error && !title.trim()" class="add-task__error">
      Title is required.
    </div>
    <div class="add-task__section">
      <label class="add-task__label">
        Description <span class="add-task__optional">(optional)</span>
      </label>
      <textarea
        class="add-task__description"
        placeholder="Enter a Description"
        [(ngModel)]="description"
        name="description"
      ></textarea>
    </div>
    <div class="add-task__section">
      <label class="add-task__label">Due date</label>
      <div class="add-task__date-row">
        <input
          #dueInput
          class="add-task__date"
          type="date"
          [(ngModel)]="dueDate"
          name="dueDate"
          (click)="openDatepicker(dueInput)"
        />
        <img
          class="add-task__date-icon"
          src="/assets/img/datepicker_calendar_icon.png"
          alt="Calendar"
          (click)="openDatepicker(dueInput)"
        />
      </div>
      <div *ngIf="error && !dueDate.trim()" class="add-task__error">
        Due date is required.
      </div>
    </div>
    <div class="add-task__section">
      <label class="add-task__label">Priority</label>
      <div class="add-task__priority-row">
        <button
          type="button"
          class="add-task__priority add-task__priority--urgent"
          [class.add-task__priority--active]="priority === 'urgent'"
          (click)="setPriority('urgent')"
          (mouseenter)="setHover('urgent')"
          (mouseleave)="setHover(null)"
        >
          Urgent
          <img
            [src]="
              priority === 'urgent' || hoverPriority === 'urgent'
                ? '/assets/img/urgent_prio_icon_white.png'
                : '/assets/img/urgent_prio_icon_red.png'
            "
            alt="Urgent"
          />
        </button>
        <button
          type="button"
          class="add-task__priority add-task__priority--medium"
          [class.add-task__priority--active]="priority === 'medium'"
          (click)="setPriority('medium')"
          (mouseenter)="setHover('medium')"
          (mouseleave)="setHover(null)"
        >
          Medium
          <img
            [src]="
              priority === 'medium' || hoverPriority === 'medium'
                ? '/assets/img/medium_prio_icon_white.png'
                : '/assets/img/medium_prio_icon_orange.png'
            "
            alt="Medium"
          />
        </button>
        <button
          type="button"
          class="add-task__priority add-task__priority--low"
          [class.add-task__priority--active]="priority === 'low'"
          (click)="setPriority('low')"
          (mouseenter)="setHover('low')"
          (mouseleave)="setHover(null)"
        >
          Low
          <img
            [src]="
              priority === 'low' || hoverPriority === 'low'
                ? '/assets/img/low_prio_icon_white.png'
                : '/assets/img/low_prio_icon_green.png'
            "
            alt="Low"
          />
        </button>
      </div>
    </div>

    <div class="add-task__section">
      <label class="add-task__label">
        Assigned to <span class="add-task__optional">(optional)</span>
      </label>
      <div class="contacts-selector-wrapper" #contactsSelectorWrapper>
        <div class="add-task__select-row">
          <input
            class="add-task__select"
            type="text"
            placeholder="Select contacts to assign"
            [(ngModel)]="contactSearch"
            (focus)="openContacts()"
            (ngModelChange)="filterContacts()"
            name="contactSearch"
          />
          <img class="add-task__select-icon" [src]="showContactsDropdown ? '/assets/img/close_dropdown_icon.png' : '/assets/img/open_dropdown_icon.png'" alt="Dropdown" (click)="toggleContacts($event)" />

          <div *ngIf="showContactsDropdown" class="assign-dropdown" (click)="$event.stopPropagation()">
            <div class="assign-dropdown__list">
              <div *ngFor="let c of filteredContacts" class="assign-dropdown__item" [ngClass]="{selected: isAssigned(c.id)}" (click)="toggleContactSelection(c)">
                <div class="assign-dropdown__avatar" [style.background]="c.color || '#ccc'">{{ getInitials(c.name) }}</div>
                <div class="assign-dropdown__name">{{ c.name }}</div>
                <img class="assign-dropdown__check" [src]="isAssigned(c.id) ? '/assets/img/checked_checkbox_icon.png' : '/assets/img/unchecked_checkbox_icon.png'" alt="check" />
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="selected-contacts-row" *ngIf="assignedTo.length > 0">
        <ng-container *ngFor="let id of assignedTo.slice(0,3); let i = index">
          <div *ngIf="getContactById(id) as contact" class="selected-contact-avatar" [style.background]="contact.color || '#ccc'">
            {{ getInitials(contact.name) }}
          </div>
        </ng-container>
        <div *ngIf="assignedTo.length > 3" class="selected-contact-avatar selected-contact-avatar--more">
          +{{ assignedTo.length - 3 }}
        </div>
      </div>
    </div>
    <div class="add-task__section">
      <label class="add-task__label">Category</label>
  <div class="add-task__select-row category-picker-row" #categoryPickerWrapper (click)="$event.stopPropagation()">
        <div class="category-picker-display" (click)="showCategoryDropdown = !showCategoryDropdown">
          <span class="category-picker-placeholder" *ngIf="!category">Select task category</span>
          <span class="category-picker-value" *ngIf="category">{{ category }}</span>
          <img class="category-picker-arrow" [class.open]="showCategoryDropdown" src="/assets/img/open_dropdown_icon.png" alt="Dropdown" />
        </div>
        <div class="category-picker-dropdown" *ngIf="showCategoryDropdown">
          <div class="category-picker-option" [class.selected]="category === 'Technical Task'" (click)="selectCategory('Technical Task')">Technical Task</div>
          <div class="category-picker-option" [class.selected]="category === 'User Story'" (click)="selectCategory('User Story')">User Story</div>
        </div>
      </div>
      <div *ngIf="error && !category.trim()" class="add-task__error">
        Category is required.
      </div>
    </div>
    <div class="add-task__section">
      <label class="add-task__label">
        Subtasks <span class="add-task__optional">(optional)</span>
      </label>
      <div class="add-task__subtasks-row">
        <!-- Subtask Input -->
        <div class="subtask-input-wrapper" [class.focused]="subtaskInputFocused">
          <input
            #subtaskInput
            class="add-task__select subtask-input"
            type="text"
            placeholder="Add new subtask"
            [(ngModel)]="newSubtask"
            (keydown.enter)="addSubtask()"
            [disabled]="editSubtaskIndex !== null"
            (focus)="subtaskInputFocused = true"
            (blur)="subtaskInputFocused = false"
          />
          <ng-container *ngIf="!newSubtask && !subtaskInputFocused">
            <img class="subtask-icon subtask-add" src="/assets/img/add_subtask_blue_icon.png" alt="Add Subtask" (mousedown)="$event.preventDefault(); addSubtask()" />
          </ng-container>
          <ng-container *ngIf="subtaskInputFocused || newSubtask">
            <img class="subtask-icon subtask-clear" src="/assets/img/x_delete_blue_icon.png" alt="Clear" (mousedown)="$event.preventDefault(); newSubtask = ''" />
            <span class="subtask-divider"></span>
            <img class="subtask-icon subtask-check" src="/assets/img/check_blue_icon.png" alt="Add" (mousedown)="$event.preventDefault(); addSubtask()" />
          </ng-container>
        </div>
      </div>
      <div class="subtasks-list">
        <div *ngFor="let sub of subtasks; let i = index" class="subtask-list-item">
          <span class="subtask-dot">â€¢</span>
          <ng-container *ngIf="editSubtaskIndex !== i">
            <span class="subtask-text">{{ sub }}</span>
            <img class="subtask-icon subtask-edit" src="/assets/img/edit_icon_blue.png" alt="Edit" (click)="startEditSubtask(i)" />
            <img class="subtask-icon subtask-delete" src="/assets/img/delete_icon_blue.png" alt="Delete" (click)="removeSubtask(i)" />
          </ng-container>
          <ng-container *ngIf="editSubtaskIndex === i">
            <input class="add-task__select subtask-edit-input" type="text" [(ngModel)]="editSubtaskValue" (keydown.enter)="confirmEditSubtask()" />
            <img class="subtask-icon subtask-clear" src="/assets/img/clear_small_icon.png" alt="Cancel" (click)="cancelEditSubtask()" />
            <span class="subtask-divider"></span>
            <img class="subtask-icon subtask-check" src="/assets/img/check_small_icon.png" alt="Save" (click)="confirmEditSubtask()" />
          </ng-container>
        </div>
      </div>
      <div class="add-task__subtasks-row add-task__subtasks-row--actions">
        <button type="button" class="add-task__create-btn" (click)="clearForm()">
          Clear
          <img src="/assets/img/clear_small_icon.png" alt="Clear Icon" />
        </button>
        <button type="submit" class="add-task__create-btn">
          Create Task
          <img src="/assets/img/check_small_icon.png" alt="Create" />
        </button>
      </div>
    </div>
    <div
      *ngIf="error && !(!title.trim() || !dueDate.trim() || !category.trim())"
      class="add-task__error"
    >
      {{ error }}
    </div>
  </form>
</div>
