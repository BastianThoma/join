<div class="add-task">
  <form class="add-task__form" (ngSubmit)="onSubmit()">
    <div *ngIf="success" class="add-task__success">{{ success }}</div>
    <input
      class="add-task__title"
      type="text"
      placeholder="Enter a title"
      required
      [(ngModel)]="title"
      name="title"
    />
    <div *ngIf="error && !title.trim()" class="add-task__error">
      Title is required.
    </div>
    <div class="add-task__section">
      <label class="add-task__label">
        Description <span class="add-task__optional">(optional)</span>
      </label>
      <textarea
        class="add-task__description"
        placeholder="Enter a Description"
        [(ngModel)]="description"
        name="description"
      ></textarea>
    </div>
    <div class="add-task__section">
      <label class="add-task__label">Due date</label>
      <div class="add-task__date-row">
        <input
          #dueInput
          class="add-task__date"
          type="date"
          [(ngModel)]="dueDate"
          name="dueDate"
          (click)="openDatepicker(dueInput)"
        />
        <img
          class="add-task__date-icon"
          src="/assets/img/datepicker_calendar_icon.png"
          alt="Calendar"
          (click)="openDatepicker(dueInput)"
        />
      </div>
      <div *ngIf="error && !dueDate.trim()" class="add-task__error">
        Due date is required.
      </div>
    </div>
    <div class="add-task__section">
      <label class="add-task__label">Priority</label>
      <div class="add-task__priority-row">
        <button
          type="button"
          class="add-task__priority add-task__priority--urgent"
          [class.add-task__priority--active]="priority === 'urgent'"
          (click)="setPriority('urgent')"
          (mouseenter)="setHover('urgent')"
          (mouseleave)="setHover(null)"
        >
          Urgent
          <img
            [src]="
              priority === 'urgent' || hoverPriority === 'urgent'
                ? '/assets/img/urgent_prio_icon_white.png'
                : '/assets/img/urgent_prio_icon_red.png'
            "
            alt="Urgent"
          />
        </button>
        <button
          type="button"
          class="add-task__priority add-task__priority--medium"
          [class.add-task__priority--active]="priority === 'medium'"
          (click)="setPriority('medium')"
          (mouseenter)="setHover('medium')"
          (mouseleave)="setHover(null)"
        >
          Medium
          <img
            [src]="
              priority === 'medium' || hoverPriority === 'medium'
                ? '/assets/img/medium_prio_icon_white.png'
                : '/assets/img/medium_prio_icon_orange.png'
            "
            alt="Medium"
          />
        </button>
        <button
          type="button"
          class="add-task__priority add-task__priority--low"
          [class.add-task__priority--active]="priority === 'low'"
          (click)="setPriority('low')"
          (mouseenter)="setHover('low')"
          (mouseleave)="setHover(null)"
        >
          Low
          <img
            [src]="
              priority === 'low' || hoverPriority === 'low'
                ? '/assets/img/low_prio_icon_white.png'
                : '/assets/img/low_prio_icon_green.png'
            "
            alt="Low"
          />
        </button>
      </div>
    </div>

    <div class="add-task__section">
      <label class="add-task__label">
        Assigned to <span class="add-task__optional">(optional)</span>
      </label>
      <div class="contacts-selector-wrapper" #contactsSelectorWrapper>
        <div class="add-task__select-row">
          <input
            class="add-task__select"
            type="text"
            placeholder="Select contacts to assign"
            [(ngModel)]="contactSearch"
            (focus)="openContacts()"
            (ngModelChange)="filterContacts()"
            name="contactSearch"
          />
          <img class="add-task__select-icon" [src]="showContactsDropdown ? '/assets/img/close_dropdown_icon.png' : '/assets/img/open_dropdown_icon.png'" alt="Dropdown" (click)="toggleContacts($event)" />

          <div *ngIf="showContactsDropdown" class="assign-dropdown" (click)="$event.stopPropagation()">
            <div class="assign-dropdown__list">
              <div *ngFor="let c of filteredContacts" class="assign-dropdown__item" [ngClass]="{selected: isAssigned(c.id)}" (click)="toggleContactSelection(c)">
                <div class="assign-dropdown__avatar" [style.background]="c.color || '#ccc'">{{ getInitials(c.name) }}</div>
                <div class="assign-dropdown__name">{{ c.name }}</div>
                <img class="assign-dropdown__check" [src]="isAssigned(c.id) ? '/assets/img/checked_checkbox_icon.png' : '/assets/img/unchecked_checkbox_icon.png'" alt="check" />
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="selected-contacts-row" *ngIf="assignedTo.length > 0">
        <ng-container *ngFor="let id of assignedTo.slice(0,3); let i = index">
          <div *ngIf="getContactById(id) as contact" class="selected-contact-avatar" [style.background]="contact.color || '#ccc'">
            {{ getInitials(contact.name) }}
          </div>
        </ng-container>
        <div *ngIf="assignedTo.length > 3" class="selected-contact-avatar selected-contact-avatar--more">
          +{{ assignedTo.length - 3 }}
        </div>
      </div>
    </div>
    <div class="add-task__section">
      <label class="add-task__label">Category</label>
      <div class="add-task__select-row">
        <select class="add-task__select" [(ngModel)]="category" name="category">
          <option disabled value="">Select task category</option>
          <!-- <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option> -->
        </select>
        <img
          class="add-task__select-icon"
          src="/assets/img/open_dropdown_icon.png"
          alt="Dropdown"
        />
      </div>
      <div *ngIf="error && !category.trim()" class="add-task__error">
        Category is required.
      </div>
    </div>
    <div class="add-task__section">
      <label class="add-task__label">
        Subtasks <span class="add-task__optional">(optional)</span>
      </label>
      <div class="add-task__subtasks-row">
        <div
          *ngFor="let sub of subtasks; let i = index"
          class="add-task__subtask add-task__subtask--filled"
        >
          {{ sub }}
        </div>
        <button type="button" class="add-task__create-btn" (click)="clearForm()">
          Clear
          <img src="/assets/img/clear_small_icon.png" alt="Clear Icon" />
        </button>
        <button type="submit" class="add-task__create-btn">
          Create Task
          <img src="/assets/img/check_small_icon.png" alt="Create" />
        </button>
      </div>
    </div>
    <div
      *ngIf="error && !(!title.trim() || !dueDate.trim() || !category.trim())"
      class="add-task__error"
    >
      {{ error }}
    </div>
  </form>
</div>
